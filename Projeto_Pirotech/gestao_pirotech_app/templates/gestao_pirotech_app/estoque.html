{% extends 'gestao_pirotech_app/base.html' %}
<!--Separacao-->
{% block title %}Gerenciar Estoque - Pirotech{% endblock title %}
<!--separacao-->
{% block content %}
<h1 class="text-3xl font-bold mb-4 text-center">Gerenciar Estoque</h1>

{% if messages %} {% for message in messages %}
<div
  class="p-4 mb-4 text-sm {% if message.tags == 'error' %}text-red-800 bg-red-100{% else %}text-green-800 bg-green-100{% endif %} rounded-lg"
>
  {{ message }}
</div>
{% endfor %} {% endif %}
<!--Separacao-->
{% if user.perfil.cargo == 'vendedor' %}
<div class="grid grid-cols-2 gap-8 mb-8">
  <div
    class="w-full bg-pirotech-preto p-6 rounded-lg border border-pirotech-cinza/20"
  >
    <h3 class="text-xl font-bold border-b border-pirotech-cinza/20 pb-2 mb-4">
      Tabela de Preços (Catálogo)
    </h3>
    <div class="overflow-auto max-h-[525px]">
      <table class="w-full text-left text-sm">
        <thead
          class="bg-pirotech-preto/50 border-b border-pirotech-cinza/20 top-0"
        >
          <th class="p-2">Animal</th>
          <th class="p-2">Tipo</th>
          <th class="p-2">Peso</th>
          <th class="p-2">Preço Venda (R$)</th>
          <th class="p-2">Preço Custo (R$)</th>
        </thead>
        <tbody>
          {% for animal, tipos in catalogo_racoes.items %}
          <!---->
          {% for tipo, pesos in tipos.items %}
          <!---->
          {% for peso, data in pesos.items %}
          <tr class="border-b border-pirotech-cinza/10">
            <td class="p-2 capitalize">{{ animal }}</td>
            <td class="p-2 capitalize">{{ tipo }}</td>
            <td class="p-2">{{ peso }}</td>
            <td class="p-2">{{ data.preco_venda }}</td>
            <td class="p-2">{{ data.preco_custo }}</td>
          </tr>
          {% endfor %}
          <!---->
          {% endfor %}
          <!---->
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div
    class="w-full bg-pirotech-preto p-6 rounded-lg border border-pirotech-cinza/20"
  >
    <h2
      class="text-xl font-semibold mb-4 border-b border-pirotech-cinza/20 pb-2"
    >
      Adicionar Novo Produto ao Estoque
    </h2>
    <form
      method="POST"
      action="{% url 'gestao-estoque' %}"
      autocomplete="off"
      class="space-y-3"
    >
      {% csrf_token %}
      <input type="hidden" name="action" value="create" />

      <div>
        <label
          for="{{ form_criacao.animal.id_for_label }}"
          class="font-semibold block mb-1"
          >Animal</label
        >
        <input
          type="text"
          name="animal"
          required
          id="{{ form_criacao.animal.id_for_label }}"
          class="w-full border rounded p-2 bg-pirotech-preto border-pirotech-cinza/30 focus:border-pirotech-roxo focus:ring-pirotech-roxo"
        />
      </div>
      <div>
        <label
          for="{{ form_criacao.tipo.id_for_label }}"
          class="font-semibold block mb-1"
          >Tipo (premium/normal)</label
        >
        <input
          type="text"
          name="tipo"
          required
          id="{{ form_criacao.tipo.id_for_label }}"
          class="w-full border rounded p-2 bg-pirotech-preto border-pirotech-cinza/30 focus:border-pirotech-roxo focus:ring-pirotech-roxo"
        />
      </div>
      <div>
        <label
          for="{{ form_criacao.peso.id_for_label }}"
          class="font-semibold block mb-1"
          >Peso (ex: 5.00, 0.50)</label
        >
        <input
          type="number"
          step="0.01"
          name="peso"
          required
          id="{{ form_criacao.peso.id_for_label }}"
          class="w-full border rounded p-2 bg-pirotech-preto border-pirotech-cinza/30 focus:border-pirotech-roxo focus:ring-pirotech-roxo"
        />
      </div>
      <div>
        <label
          for="{{ form_criacao.preco.id_for_label }}"
          class="font-semibold block mb-1"
          >Preço Venda (R$)</label
        >
        <input
          type="number"
          step="0.01"
          name="preco"
          required
          id="{{ form_criacao.preco.id_for_label }}"
          class="w-full border rounded p-2 bg-pirotech-preto border-pirotech-cinza/30 focus:border-pirotech-roxo focus:ring-pirotech-roxo"
        />
      </div>
      <div>
        <label
          for="{{ form_criacao.preco_de_custo.id_for_label }}"
          class="font-semibold block mb-1"
          >Preço Custo (R$)</label
        >
        <input
          type="number"
          step="0.01"
          name="preco_de_custo"
          required
          id="{{ form_criacao.preco_de_custo.id_for_label }}"
          class="w-full border rounded p-2 bg-pirotech-preto border-pirotech-cinza/30 focus:border-pirotech-roxo focus:ring-pirotech-roxo"
        />
      </div>
      <div>
        <label
          for="{{ form_criacao.quantidade.id_for_label }}"
          class="font-semibold block mb-1"
          >Quantidade</label
        >
        <input
          type="number"
          name="quantidade"
          required
          id="{{ form_criacao.quantidade.id_for_label }}"
          min="0"
          class="w-full border rounded p-2 bg-pirotech-preto border-pirotech-cinza/30 focus:border-pirotech-roxo focus:ring-pirotech-roxo"
        />
      </div>

      <button
        type="submit"
        class="bg-pirotech-roxo-default hover:bg-pirotech-roxo-dark text-white font-bold py-2 px-4 rounded h-10 mt-2"
      >
        Adicionar Produto
      </button>
    </form>
  </div>
</div>
{%endif%}
<div class="bg-pirotech-preto p-6 rounded-lg border border-pirotech-cinza/20">
  <h3 class="text-xl font-bold border-b border-pirotech-cinza/20 pb-2 mb-4">
    Seu Estoque Atual
  </h3>
  <div class="overflow-x-auto">
    <table class="w-full text-left min-w-[800px]">
      <thead class="bg-pirotech-preto/50 border-b border-pirotech-cinza/20">
        <tr>
          <th class="p-2">Animal</th>
          <th class="p-2">Tipo</th>
          <th class="p-2">Peso</th>
          <th class="p-2">Preço Venda</th>
          <th class="p-2">Preço Custo</th>
          <th class="p-2">Quantidade</th>
          {% if user.is_superuser %}
          <th class="p-2">Vendedor</th>
          {% endif %}
          <th class="p-2 text-center">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for produto in produtos %}
        <tr
          class="border-b border-pirotech-cinza/10 hover:bg-pirotech-preto/30"
        >
          <td class="p-2">
            <input
              type="text"
              form="update-form-{{ produto.id }}"
              name="animal"
              value="{{ produto.animal.capitalize }}"
              class="w-full border rounded p-1 bg-pirotech-preto border-pirotech-cinza/30"
            />
          </td>
          <td class="p-2">
            <input
              type="text"
              form="update-form-{{ produto.id }}"
              name="tipo"
              value="{{ produto.tipo.capitalize }}"
              class="w-full border rounded p-1 bg-pirotech-preto border-pirotech-cinza/30"
            />
          </td>
          <td class="p-2">
            <input
              type="number"
              step="0.01"
              form="update-form-{{ produto.id }}"
              name="peso"
              value="{{ produto.peso|stringformat:'.2f' }}"
              class="w-full border rounded p-1 bg-pirotech-preto border-pirotech-cinza/30"
            />
          </td>
          <td class="p-2">
            <input
              type="number"
              step="0.01"
              form="update-form-{{ produto.id }}"
              name="preco"
              value="{{ produto.preco|stringformat:'.2f' }}"
              class="w-full border rounded p-1 bg-pirotech-preto border-pirotech-cinza/30"
            />
          </td>
          <td class="p-2">
            <input
              type="number"
              step="0.01"
              form="update-form-{{ produto.id }}"
              name="preco_de_custo"
              value="{{ produto.preco_de_custo|stringformat:'.2f' }}"
              class="w-full border rounded p-1 bg-pirotech-preto border-pirotech-cinza/30"
            />
          </td>
          <td class="p-2">
            <input
              type="number"
              form="update-form-{{ produto.id }}"
              name="quantidade"
              value="{{ produto.quantidade }}"
              required
              min="0"
              class="w-20 border rounded p-1 bg-pirotech-preto border-pirotech-cinza/30"
            />
          </td>

          <input
            type="hidden"
            form="update-form-{{ produto.id }}"
            name="nome"
            value="{{ produto.nome }}"
          />

          {% if user.is_superuser %}
          <td class="p-2 text-sm text-pirotech-cinza">
            {{ produto.usuario.username }}
          </td>
          {% endif %}

          <td class="p-2 text-center whitespace-nowrap">
            <div class="flex items-center justify-center gap-x-2">
              <form
                id="update-form-{{ produto.id }}"
                action="{% url 'gestao-estoque' %}"
                method="POST"
              >
                {% csrf_token %}
                <input type="hidden" name="action" value="update" />
                <input
                  type="hidden"
                  name="produto_id"
                  value="{{ produto.id }}"
                />
                <button
                  type="submit"
                  class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm"
                >
                  Atualizar
                </button>
              </form>

              <form
                action="{% url 'gestao-estoque' %}"
                method="POST"
                class="inline"
                onsubmit="return confirm('Tem certeza que deseja remover este item?');"
              >
                {% csrf_token %}
                <input type="hidden" name="action" value="delete" />
                <input
                  type="hidden"
                  name="produto_id"
                  value="{{ produto.id }}"
                />
                <button
                  type="submit"
                  class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm"
                >
                  Deletar
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td
            colspan="{% if user.is_superuser %}8{% else %}7{% endif %}"
            class="text-center p-4 text-pirotech-cinza"
          >
            Seu Estoque está vazio
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock content %}
